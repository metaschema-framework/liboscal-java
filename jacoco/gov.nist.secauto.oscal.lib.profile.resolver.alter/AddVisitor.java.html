<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AddVisitor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OSCAL Java Library</a> &gt; <a href="index.source.html" class="el_package">gov.nist.secauto.oscal.lib.profile.resolver.alter</a> &gt; <span class="el_source">AddVisitor.java</span></div><h1>AddVisitor.java</h1><pre class="source lang-java linenums">/*
 * SPDX-FileCopyrightText: none
 * SPDX-License-Identifier: CC0-1.0
 */

package gov.nist.secauto.oscal.lib.profile.resolver.alter;

import gov.nist.secauto.metaschema.core.datatype.markup.MarkupLine;
import gov.nist.secauto.metaschema.core.util.CollectionUtil;
import gov.nist.secauto.metaschema.core.util.CustomCollectors;
import gov.nist.secauto.metaschema.core.util.ObjectUtils;
import gov.nist.secauto.oscal.lib.model.Catalog;
import gov.nist.secauto.oscal.lib.model.CatalogGroup;
import gov.nist.secauto.oscal.lib.model.Control;
import gov.nist.secauto.oscal.lib.model.ControlPart;
import gov.nist.secauto.oscal.lib.model.Link;
import gov.nist.secauto.oscal.lib.model.Parameter;
import gov.nist.secauto.oscal.lib.model.Property;
import gov.nist.secauto.oscal.lib.model.control.catalog.ICatalogVisitor;
import gov.nist.secauto.oscal.lib.profile.resolver.ProfileResolutionEvaluationException;

import java.util.Collections;
import java.util.EnumMap;
import java.util.EnumSet;
import java.util.LinkedList;
import java.util.List;
import java.util.ListIterator;
import java.util.Locale;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.ConcurrentHashMap;
import java.util.function.Consumer;
import java.util.function.Function;
import java.util.function.Supplier;

import edu.umd.cs.findbugs.annotations.NonNull;
import edu.umd.cs.findbugs.annotations.Nullable;

@SuppressWarnings(&quot;PMD.CouplingBetweenObjects&quot;)
<span class="fc" id="L40">public class AddVisitor implements ICatalogVisitor&lt;Boolean, AddVisitor.Context&gt; {</span>
<span class="fc" id="L41">  public enum TargetType {</span>
<span class="fc" id="L42">    CONTROL(&quot;control&quot;, Control.class),</span>
<span class="fc" id="L43">    PARAM(&quot;param&quot;, Parameter.class),</span>
<span class="fc" id="L44">    PART(&quot;part&quot;, ControlPart.class);</span>

    @NonNull
    private static final Map&lt;Class&lt;?&gt;, TargetType&gt; CLASS_TO_TYPE;
    @NonNull
    private static final Map&lt;String, TargetType&gt; NAME_TO_TYPE;
    @NonNull
    private final String fieldName;
    @NonNull
    private final Class&lt;?&gt; clazz;

    static {
      {
<span class="fc" id="L57">        Map&lt;Class&lt;?&gt;, TargetType&gt; map = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc bfc" id="L58" title="All 2 branches covered.">        for (TargetType type : values()) {</span>
<span class="fc" id="L59">          map.put(type.getClazz(), type);</span>
        }
<span class="fc" id="L61">        CLASS_TO_TYPE = CollectionUtil.unmodifiableMap(map);</span>
      }

      {
<span class="fc" id="L65">        Map&lt;String, TargetType&gt; map = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">        for (TargetType type : values()) {</span>
<span class="fc" id="L67">          map.put(type.fieldName(), type);</span>
        }
<span class="fc" id="L69">        NAME_TO_TYPE = CollectionUtil.unmodifiableMap(map);</span>
      }
<span class="fc" id="L71">    }</span>

    /**
     * Get the target type associated with the provided {@code clazz}.
     *
     * @param clazz
     *          the class to identify the target type for
     * @return the associated target type or {@code null} if the class is not
     *         associated with a target type
     */
    @Nullable
    public static TargetType forClass(@NonNull Class&lt;?&gt; clazz) {
<span class="fc" id="L83">      Class&lt;?&gt; target = clazz;</span>
      TargetType retval;
      // recurse over parent classes to find a match
      do {
<span class="fc" id="L87">        retval = CLASS_TO_TYPE.get(target);</span>
<span class="pc bpc" id="L88" title="3 of 4 branches missed.">      } while (retval == null &amp;&amp; (target = target.getSuperclass()) != null);</span>
<span class="fc" id="L89">      return retval;</span>
    }

    /**
     * Get the target type associated with the provided field {@code name}.
     *
     * @param name
     *          the field name to identify the target type for
     * @return the associated target type or {@code null} if the name is not
     *         associated with a target type
     */
    @Nullable
    public static TargetType forFieldName(@Nullable String name) {
<span class="nc bnc" id="L102" title="All 2 branches missed.">      return name == null ? null : NAME_TO_TYPE.get(name);</span>
    }

<span class="fc" id="L105">    TargetType(@NonNull String fieldName, @NonNull Class&lt;?&gt; clazz) {</span>
<span class="fc" id="L106">      this.fieldName = fieldName;</span>
<span class="fc" id="L107">      this.clazz = clazz;</span>
<span class="fc" id="L108">    }</span>

    /**
     * Get the field name associated with the target type.
     *
     * @return the name
     */
    public String fieldName() {
<span class="fc" id="L116">      return fieldName;</span>
    }

    /**
     * Get the bound class associated with the target type.
     *
     * @return the class
     */
    public Class&lt;?&gt; getClazz() {
<span class="fc" id="L125">      return clazz;</span>
    }
  }

<span class="fc" id="L129">  public enum Position {</span>
<span class="fc" id="L130">    BEFORE,</span>
<span class="fc" id="L131">    AFTER,</span>
<span class="fc" id="L132">    STARTING,</span>
<span class="fc" id="L133">    ENDING;</span>

    @NonNull
    private static final Map&lt;String, Position&gt; NAME_TO_POSITION;

    static {
<span class="fc" id="L139">      Map&lt;String, Position&gt; map = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">      for (Position position : values()) {</span>
<span class="fc" id="L141">        map.put(position.name().toLowerCase(Locale.ROOT), position);</span>
      }
<span class="fc" id="L143">      NAME_TO_POSITION = CollectionUtil.unmodifiableMap(map);</span>
<span class="fc" id="L144">    }</span>

    /**
     * Get the position associated with the provided {@code name}.
     *
     * @param name
     *          the name to identify the position for
     * @return the associated position or {@code null} if the name is not associated
     *         with a position
     */
    @Nullable
    public static Position forName(@Nullable String name) {
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">      return name == null ? null : NAME_TO_POSITION.get(name);</span>
    }
  }

  @NonNull
<span class="fc" id="L161">  private static final AddVisitor INSTANCE = new AddVisitor();</span>
  private static final Map&lt;TargetType, Set&lt;TargetType&gt;&gt; APPLICABLE_TARGETS;

  static {
<span class="fc" id="L165">    APPLICABLE_TARGETS = new EnumMap&lt;&gt;(TargetType.class);</span>
<span class="fc" id="L166">    APPLICABLE_TARGETS.put(TargetType.CONTROL, Set.of(TargetType.CONTROL, TargetType.PARAM, TargetType.PART));</span>
<span class="fc" id="L167">    APPLICABLE_TARGETS.put(TargetType.PARAM, Set.of(TargetType.PARAM));</span>
<span class="fc" id="L168">    APPLICABLE_TARGETS.put(TargetType.PART, Set.of(TargetType.PART));</span>
<span class="fc" id="L169">  }</span>

  private static Set&lt;TargetType&gt; getApplicableTypes(@NonNull TargetType type) {
<span class="fc" id="L172">    return APPLICABLE_TARGETS.getOrDefault(type, CollectionUtil.emptySet());</span>
  }

  /**
   * Apply the add directive.
   *
   * @param control
   *          the control target
   * @param position
   *          the position to apply the content or {@code null}
   * @param byId
   *          the identifier of the target or {@code null}
   * @param title
   *          a title to set
   * @param params
   *          parameters to add
   * @param props
   *          properties to add
   * @param links
   *          links to add
   * @param parts
   *          parts to add
   * @return {@code true} if the modification was made or {@code false} otherwise
   * @throws ProfileResolutionEvaluationException
   *           if a processing error occurred during profile resolution
   */
  public static boolean add(
      @NonNull Control control,
      @Nullable Position position,
      @Nullable String byId,
      @Nullable MarkupLine title,
      @NonNull List&lt;Parameter&gt; params,
      @NonNull List&lt;Property&gt; props,
      @NonNull List&lt;Link&gt; links,
      @NonNull List&lt;ControlPart&gt; parts) {
<span class="fc" id="L207">    return INSTANCE.visitControl(</span>
        control,
<span class="fc" id="L209">        Context.newContext(</span>
            control,
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">            position == null ? Position.ENDING : position,</span>
            byId,
            title,
            params,
            props,
            links,
            parts));
  }

  @Override
  public Boolean visitCatalog(Catalog catalog, Context context) {
    // not required
<span class="nc" id="L223">    throw new UnsupportedOperationException(&quot;not needed&quot;);</span>
  }

  @Override
  public Boolean visitGroup(CatalogGroup group, Context context) {
    // not required
<span class="nc" id="L229">    throw new UnsupportedOperationException(&quot;not needed&quot;);</span>
  }

  /**
   * If the add applies to the current object, then apply the child objects.
   * &lt;p&gt;
   * An add applies if:
   * &lt;ol&gt;
   * &lt;li&gt;the {@code targetItem} supports all of the children&lt;/li&gt;
   * &lt;li&gt;the context matches if:
   * &lt;ul&gt;
   * &lt;li&gt;the target item's id matches the &quot;by-id&quot;; or&lt;/li&gt;
   * &lt;li&gt;the &quot;by-id&quot; is not defined and the target item is the control matching
   * the target context&lt;/li&gt;
   * &lt;/ul&gt;
   * &lt;/li&gt;
   * &lt;/ol&gt;
   *
   * @param &lt;T&gt;
   *          the type of the {@code targetItem}
   * @param targetItem
   *          the current target to process
   * @param titleConsumer
   *          a consumer to apply a title to or {@code null} if the object has no
   *          title field
   * @param paramsSupplier
   *          a supplier for the child {@link Parameter} collection
   * @param propsSupplier
   *          a supplier for the child {@link Property} collection
   * @param linksSupplier
   *          a supplier for the child {@link Link} collection
   * @param partsSupplier
   *          a supplier for the child {@link ControlPart} collection
   * @param context
   *          the add context
   * @return {@code true} if a modification was made or {@code false} otherwise
   */
  private static &lt;T&gt; boolean handleCurrent(
      @NonNull T targetItem,
      @Nullable Consumer&lt;MarkupLine&gt; titleConsumer,
      @Nullable Supplier&lt;? extends List&lt;Parameter&gt;&gt; paramsSupplier,
      @Nullable Supplier&lt;? extends List&lt;Property&gt;&gt; propsSupplier,
      @Nullable Supplier&lt;? extends List&lt;Link&gt;&gt; linksSupplier,
      @Nullable Supplier&lt;? extends List&lt;ControlPart&gt;&gt; partsSupplier,
      @NonNull Context context) {
<span class="fc" id="L274">    boolean retval = false;</span>
<span class="fc" id="L275">    Position position = context.getPosition();</span>
<span class="pc bpc" id="L276" title="1 of 4 branches missed.">    if (context.appliesTo(targetItem) &amp;&amp; !context.isSequenceTargeted(targetItem)) {</span>
      // the target item is the target of the add
<span class="fc" id="L278">      MarkupLine newTitle = context.getTitle();</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">      if (newTitle != null) {</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">        assert titleConsumer != null;</span>
<span class="nc" id="L281">        titleConsumer.accept(newTitle);</span>
      }

<span class="fc" id="L284">      handleCollection(position, context.getParams(), paramsSupplier);</span>
<span class="fc" id="L285">      handleCollection(position, context.getProps(), propsSupplier);</span>
<span class="fc" id="L286">      handleCollection(position, context.getLinks(), linksSupplier);</span>
<span class="fc" id="L287">      handleCollection(position, context.getParts(), partsSupplier);</span>
<span class="fc" id="L288">      retval = true;</span>
    }
<span class="fc" id="L290">    return retval;</span>
  }

  private static &lt;T&gt; void handleCollection(
      @NonNull Position position,
      @NonNull List&lt;T&gt; newItems,
      @Nullable Supplier&lt;? extends List&lt;T&gt;&gt; originalCollectionSupplier) {
<span class="fc bfc" id="L297" title="All 2 branches covered.">    if (originalCollectionSupplier != null) {</span>
<span class="fc" id="L298">      List&lt;T&gt; oldItems = originalCollectionSupplier.get();</span>
<span class="fc bfc" id="L299" title="All 2 branches covered.">      if (!newItems.isEmpty()) {</span>
<span class="fc bfc" id="L300" title="All 2 branches covered.">        if (Position.STARTING.equals(position)) {</span>
<span class="fc" id="L301">          oldItems.addAll(0, newItems);</span>
        } else { // ENDING
<span class="fc" id="L303">          oldItems.addAll(newItems);</span>
        }
      }
    }
<span class="fc" id="L307">  }</span>

  // private static &lt;T&gt; void handleChild(
  // @NonNull TargetType itemType,
  // @NonNull Supplier&lt;? extends List&lt;T&gt;&gt; collectionSupplier,
  // @Nullable Consumer&lt;T&gt; handler,
  // @NonNull Context context) {
  // boolean handleChildren = !Collections.disjoint(context.getTargetItemTypes(),
  // getApplicableTypes(itemType));
  // if (handleChildren &amp;&amp; handler != null) {
  // // if the child item type is applicable and there is a handler, iterate over
  // children
  // Iterator&lt;T&gt; iter = collectionSupplier.get().iterator();
  // while (iter.hasNext()) {
  // T item = iter.next();
  // if (item != null) {
  // handler.accept(item);
  // }
  // }
  // }
  // }

  @SuppressWarnings({ &quot;PMD.CyclomaticComplexity&quot;, &quot;PMD.CognitiveComplexity&quot; })
  private static &lt;T&gt; boolean handleChild(
      @NonNull TargetType itemType,
      @NonNull Supplier&lt;? extends List&lt;T&gt;&gt; originalCollectionSupplier,
      @NonNull Supplier&lt;? extends List&lt;T&gt;&gt; newItemsSupplier,
      @Nullable Function&lt;T, Boolean&gt; handler,
      @NonNull Context context) {

    // determine if this child type can match
<span class="fc" id="L338">    boolean isItemTypeMatch = context.isMatchingType(itemType);</span>

<span class="fc" id="L340">    Set&lt;TargetType&gt; applicableTypes = getApplicableTypes(itemType);</span>
<span class="pc bpc" id="L341" title="1 of 4 branches missed.">    boolean descendChild = handler != null &amp;&amp; !Collections.disjoint(context.getTargetItemTypes(), applicableTypes);</span>

<span class="fc" id="L343">    boolean retval = false;</span>
<span class="pc bpc" id="L344" title="1 of 4 branches missed.">    if (isItemTypeMatch || descendChild) {</span>
      // if the item type is applicable, attempt to match by id
<span class="fc" id="L346">      List&lt;T&gt; collection = originalCollectionSupplier.get();</span>
<span class="fc" id="L347">      ListIterator&lt;T&gt; iter = collection.listIterator();</span>
<span class="fc" id="L348">      boolean deferred = false;</span>
<span class="fc bfc" id="L349" title="All 2 branches covered.">      while (iter.hasNext()) {</span>
<span class="fc" id="L350">        T item = ObjectUtils.requireNonNull(iter.next());</span>

<span class="pc bpc" id="L352" title="1 of 6 branches missed.">        if (isItemTypeMatch &amp;&amp; context.appliesTo(item) &amp;&amp; context.isSequenceTargeted(item)) {</span>
          // if id match, inject the new items into the collection
<span class="pc bpc" id="L354" title="2 of 4 branches missed.">          switch (context.getPosition()) {</span>
          case AFTER: {
<span class="fc" id="L356">            newItemsSupplier.get().forEach(iter::add);</span>
<span class="fc" id="L357">            retval = true;</span>
<span class="fc" id="L358">            break;</span>
          }
          case BEFORE: {
<span class="fc" id="L361">            iter.previous();</span>
<span class="fc" id="L362">            List&lt;T&gt; adds = newItemsSupplier.get();</span>
<span class="fc" id="L363">            adds.forEach(iter::add);</span>
<span class="fc" id="L364">            item = iter.next();</span>
<span class="fc" id="L365">            retval = true;</span>
<span class="fc" id="L366">            break;</span>
          }
          case STARTING:
          case ENDING:
<span class="nc" id="L370">            deferred = true;</span>
<span class="nc" id="L371">            break;</span>
          default:
<span class="nc" id="L373">            throw new UnsupportedOperationException(context.getPosition().name().toLowerCase(Locale.ROOT));</span>
          }
        }

<span class="pc bpc" id="L377" title="1 of 2 branches missed.">        if (descendChild) {</span>
<span class="pc bpc" id="L378" title="1 of 2 branches missed.">          assert handler != null;</span>

          // handle child items since they are applicable to the search criteria
<span class="fc bfc" id="L381" title="All 4 branches covered.">          retval = retval || handler.apply(item);</span>
        }
<span class="fc" id="L383">      }</span>

<span class="pc bpc" id="L385" title="1 of 2 branches missed.">      if (deferred) {</span>
<span class="nc" id="L386">        List&lt;T&gt; newItems = newItemsSupplier.get();</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">        if (Position.ENDING.equals(context.getPosition())) {</span>
<span class="nc" id="L388">          collection.addAll(newItems);</span>
<span class="nc" id="L389">          retval = true;</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">        } else if (Position.STARTING.equals(context.getPosition())) {</span>
<span class="nc" id="L391">          collection.addAll(0, newItems);</span>
<span class="nc" id="L392">          retval = true;</span>
        }
      }
    }
<span class="fc" id="L396">    return retval;</span>
  }

  @Override
  public Boolean visitControl(Control control, Context context) {
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">    assert context != null;</span>

<span class="pc bpc" id="L403" title="1 of 2 branches missed.">    if (control.getParams() == null) {</span>
<span class="nc" id="L404">      control.setParams(new LinkedList&lt;&gt;());</span>
    }

<span class="pc bpc" id="L407" title="1 of 2 branches missed.">    if (control.getProps() == null) {</span>
<span class="nc" id="L408">      control.setProps(new LinkedList&lt;&gt;());</span>
    }

<span class="pc bpc" id="L411" title="1 of 2 branches missed.">    if (control.getLinks() == null) {</span>
<span class="nc" id="L412">      control.setLinks(new LinkedList&lt;&gt;());</span>
    }

<span class="pc bpc" id="L415" title="1 of 2 branches missed.">    if (control.getParts() == null) {</span>
<span class="nc" id="L416">      control.setParts(new LinkedList&lt;&gt;());</span>
    }

<span class="fc" id="L419">    boolean retval = handleCurrent(</span>
        control,
<span class="fc" id="L421">        control::setTitle,</span>
<span class="fc" id="L422">        control::getParams,</span>
<span class="fc" id="L423">        control::getProps,</span>
<span class="fc" id="L424">        control::getLinks,</span>
<span class="fc" id="L425">        control::getParts,</span>
        context);

    // visit params
<span class="fc bfc" id="L429" title="All 4 branches covered.">    retval = retval || handleChild(</span>
        TargetType.PARAM,
<span class="fc" id="L431">        control::getParams,</span>
<span class="fc" id="L432">        context::getParams,</span>
<span class="fc" id="L433">        child -&gt; visitParameter(ObjectUtils.notNull(child), context),</span>
        context);

    // visit parts
<span class="pc bpc" id="L437" title="1 of 4 branches missed.">    retval = retval || handleChild(</span>
        TargetType.PART,
<span class="fc" id="L439">        control::getParts,</span>
<span class="fc" id="L440">        context::getParts,</span>
<span class="fc" id="L441">        child -&gt; visitPart(child, context),</span>
        context);

    // visit control children
<span class="pc bpc" id="L445" title="1 of 2 branches missed.">    for (Control childControl : CollectionUtil.listOrEmpty(control.getControls())) {</span>
<span class="nc" id="L446">      Set&lt;TargetType&gt; applicableTypes = getApplicableTypes(TargetType.CONTROL);</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">      if (!Collections.disjoint(context.getTargetItemTypes(), applicableTypes)) {</span>
<span class="nc bnc" id="L448" title="All 4 branches missed.">        retval = retval || visitControl(ObjectUtils.requireNonNull(childControl), context);</span>
      }
<span class="nc" id="L450">    }</span>
<span class="fc" id="L451">    return retval;</span>
  }

  @Override
  public Boolean visitParameter(Parameter parameter, Context context) {
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">    assert context != null;</span>
<span class="pc bpc" id="L457" title="1 of 2 branches missed.">    if (parameter.getProps() == null) {</span>
<span class="nc" id="L458">      parameter.setProps(new LinkedList&lt;&gt;());</span>
    }

<span class="pc bpc" id="L461" title="1 of 2 branches missed.">    if (parameter.getLinks() == null) {</span>
<span class="nc" id="L462">      parameter.setLinks(new LinkedList&lt;&gt;());</span>
    }

<span class="fc" id="L465">    return handleCurrent(</span>
        parameter,
        null,
        null,
<span class="fc" id="L469">        parameter::getProps,</span>
<span class="fc" id="L470">        parameter::getLinks,</span>
        null,
        context);
  }

  /**
   * Visit the control part.
   *
   * @param part
   *          the bound part object
   * @param context
   *          the visitor context
   * @return {@code true} if the removal was applied or {@code false} otherwise
   */
  public boolean visitPart(ControlPart part, Context context) {
<span class="pc bpc" id="L485" title="1 of 2 branches missed.">    assert context != null;</span>
<span class="pc bpc" id="L486" title="1 of 2 branches missed.">    if (part.getProps() == null) {</span>
<span class="nc" id="L487">      part.setProps(new LinkedList&lt;&gt;());</span>
    }

<span class="pc bpc" id="L490" title="1 of 2 branches missed.">    if (part.getLinks() == null) {</span>
<span class="nc" id="L491">      part.setLinks(new LinkedList&lt;&gt;());</span>
    }

<span class="pc bpc" id="L494" title="1 of 2 branches missed.">    if (part.getParts() == null) {</span>
<span class="nc" id="L495">      part.setParts(new LinkedList&lt;&gt;());</span>
    }

<span class="fc" id="L498">    boolean retval = handleCurrent(</span>
        part,
        null,
        null,
<span class="fc" id="L502">        part::getProps,</span>
<span class="fc" id="L503">        part::getLinks,</span>
<span class="fc" id="L504">        part::getParts,</span>
        context);

<span class="pc bpc" id="L507" title="3 of 4 branches missed.">    return retval || handleChild(</span>
        TargetType.PART,
<span class="nc" id="L509">        part::getParts,</span>
<span class="nc" id="L510">        context::getParts,</span>
<span class="nc" id="L511">        child -&gt; visitPart(child, context),</span>
        context);
  }

  static final class Context {
    @NonNull
<span class="fc" id="L517">    private static final Set&lt;TargetType&gt; TITLE_TYPES = ObjectUtils.notNull(</span>
<span class="fc" id="L518">        Set.of(TargetType.CONTROL, TargetType.PART));</span>
    @NonNull
<span class="fc" id="L520">    private static final Set&lt;TargetType&gt; PARAM_TYPES = ObjectUtils.notNull(</span>
<span class="fc" id="L521">        Set.of(TargetType.CONTROL, TargetType.PARAM));</span>
    @NonNull
<span class="fc" id="L523">    private static final Set&lt;TargetType&gt; PROP_TYPES = ObjectUtils.notNull(</span>
<span class="fc" id="L524">        Set.of(TargetType.CONTROL, TargetType.PARAM, TargetType.PART));</span>
    @NonNull
<span class="fc" id="L526">    private static final Set&lt;TargetType&gt; LINK_TYPES = ObjectUtils.notNull(</span>
<span class="fc" id="L527">        Set.of(TargetType.CONTROL, TargetType.PARAM, TargetType.PART));</span>
    @NonNull
<span class="fc" id="L529">    private static final Set&lt;TargetType&gt; PART_TYPES = ObjectUtils.notNull(</span>
<span class="fc" id="L530">        Set.of(TargetType.CONTROL, TargetType.PART));</span>

    @NonNull
    private final Control control;
    @NonNull
    private final Position position;
    @Nullable
    private final String byId;
    @Nullable
    private final MarkupLine title;
    @NonNull
    private final List&lt;Parameter&gt; params;
    @NonNull
    private final List&lt;Property&gt; props;
    @NonNull
    private final List&lt;Link&gt; links;
    @NonNull
    private final List&lt;ControlPart&gt; parts;
    @NonNull
    private final Set&lt;TargetType&gt; targetItemTypes;

    @SuppressWarnings({ &quot;PMD.CyclomaticComplexity&quot;, &quot;PMD.CognitiveComplexity&quot;, &quot;PMD.NPathComplexity&quot; })
    public static Context newContext(
        @NonNull Control control,
        @NonNull Position position,
        @Nullable String byId,
        @Nullable MarkupLine title,
        @NonNull List&lt;Parameter&gt; params,
        @NonNull List&lt;Property&gt; props,
        @NonNull List&lt;Link&gt; links,
        @NonNull List&lt;ControlPart&gt; parts) {
<span class="fc" id="L561">      Set&lt;TargetType&gt; targetItemTypes = ObjectUtils.notNull(EnumSet.allOf(TargetType.class));</span>
<span class="fc" id="L562">      List&lt;String&gt; additionObjects = new LinkedList&lt;&gt;();</span>

<span class="fc" id="L564">      boolean sequenceTarget = true;</span>
<span class="pc bpc" id="L565" title="1 of 2 branches missed.">      if (title != null) {</span>
<span class="nc" id="L566">        targetItemTypes.retainAll(TITLE_TYPES);</span>
<span class="nc" id="L567">        additionObjects.add(&quot;title&quot;);</span>
<span class="nc" id="L568">        sequenceTarget = false;</span>
      }

<span class="fc bfc" id="L571" title="All 2 branches covered.">      if (!params.isEmpty()) {</span>
<span class="fc" id="L572">        targetItemTypes.retainAll(PARAM_TYPES);</span>
<span class="fc" id="L573">        additionObjects.add(&quot;param&quot;);</span>
      }

<span class="fc bfc" id="L576" title="All 2 branches covered.">      if (!props.isEmpty()) {</span>
<span class="fc" id="L577">        targetItemTypes.retainAll(PROP_TYPES);</span>
<span class="fc" id="L578">        additionObjects.add(&quot;prop&quot;);</span>
<span class="fc" id="L579">        sequenceTarget = false;</span>
      }

<span class="pc bpc" id="L582" title="1 of 2 branches missed.">      if (!links.isEmpty()) {</span>
<span class="nc" id="L583">        targetItemTypes.retainAll(LINK_TYPES);</span>
<span class="nc" id="L584">        additionObjects.add(&quot;link&quot;);</span>
<span class="nc" id="L585">        sequenceTarget = false;</span>
      }

<span class="fc bfc" id="L588" title="All 2 branches covered.">      if (!parts.isEmpty()) {</span>
<span class="fc" id="L589">        targetItemTypes.retainAll(PART_TYPES);</span>
<span class="fc" id="L590">        additionObjects.add(&quot;part&quot;);</span>
      }

<span class="fc bfc" id="L593" title="All 4 branches covered.">      if (Position.BEFORE.equals(position) || Position.AFTER.equals(position)) {</span>
<span class="pc bpc" id="L594" title="1 of 2 branches missed.">        if (!sequenceTarget) {</span>
<span class="nc" id="L595">          throw new ProfileResolutionEvaluationException(</span>
              &quot;When using position before or after, one collection of parameters or parts can be specified.&quot;
                  + &quot; Other additions must not be used.&quot;);
        }
<span class="pc bpc" id="L599" title="1 of 4 branches missed.">        if (!params.isEmpty() &amp;&amp; parts.isEmpty()) {</span>
<span class="fc" id="L600">          targetItemTypes.retainAll(Set.of(TargetType.PARAM));</span>
<span class="pc bpc" id="L601" title="2 of 4 branches missed.">        } else if (!parts.isEmpty() &amp;&amp; params.isEmpty()) {</span>
<span class="fc" id="L602">          targetItemTypes.retainAll(Set.of(TargetType.PART));</span>
        } else {
<span class="nc" id="L604">          throw new ProfileResolutionEvaluationException(</span>
              &quot;When using position before or after, only one collection of parameters or parts can be specified.&quot;);
        }
      }

<span class="pc bpc" id="L609" title="1 of 2 branches missed.">      if (targetItemTypes.isEmpty()) {</span>
<span class="nc" id="L610">        throw new ProfileResolutionEvaluationException(&quot;No parent object supports the requested objects to add: &quot; +</span>
<span class="nc" id="L611">            additionObjects.stream().collect(CustomCollectors.joiningWithOxfordComma(&quot;or&quot;)));</span>
      }

<span class="fc" id="L614">      return new Context(</span>
          control,
          position,
          byId,
          title,
          params,
          props,
          links,
          parts,
          targetItemTypes);
    }

    private Context(
        @NonNull Control control,
        @NonNull Position position,
        @Nullable String byId,
        @Nullable MarkupLine title,
        @NonNull List&lt;Parameter&gt; params,
        @NonNull List&lt;Property&gt; props,
        @NonNull List&lt;Link&gt; links,
        @NonNull List&lt;ControlPart&gt; parts,
<span class="fc" id="L635">        @NonNull Set&lt;TargetType&gt; targetItemTypes) {</span>
<span class="fc" id="L636">      this.control = control;</span>
<span class="fc" id="L637">      this.position = position;</span>
<span class="fc" id="L638">      this.byId = byId;</span>
<span class="fc" id="L639">      this.title = title;</span>
<span class="fc" id="L640">      this.params = params;</span>
<span class="fc" id="L641">      this.props = props;</span>
<span class="fc" id="L642">      this.links = links;</span>
<span class="fc" id="L643">      this.parts = parts;</span>
<span class="fc" id="L644">      this.targetItemTypes = CollectionUtil.unmodifiableSet(targetItemTypes);</span>
<span class="fc" id="L645">    }</span>

    @NonNull
    private Control getControl() {
<span class="nc" id="L649">      return control;</span>
    }

    @NonNull
    private Position getPosition() {
<span class="fc" id="L654">      return position;</span>
    }

    @Nullable
    private String getById() {
<span class="fc" id="L659">      return byId;</span>
    }

    @Nullable
    private MarkupLine getTitle() {
<span class="fc" id="L664">      return title;</span>
    }

    @NonNull
    private List&lt;Parameter&gt; getParams() {
<span class="fc" id="L669">      return params;</span>
    }

    @NonNull
    private List&lt;Property&gt; getProps() {
<span class="fc" id="L674">      return props;</span>
    }

    @NonNull
    private List&lt;Link&gt; getLinks() {
<span class="fc" id="L679">      return links;</span>
    }

    @NonNull
    private List&lt;ControlPart&gt; getParts() {
<span class="fc" id="L684">      return parts;</span>
    }

    @NonNull
    private Set&lt;TargetType&gt; getTargetItemTypes() {
<span class="fc" id="L689">      return targetItemTypes;</span>
    }

    private boolean isMatchingType(@NonNull TargetType type) {
<span class="fc" id="L693">      return getTargetItemTypes().contains(type);</span>
    }

    private &lt;T&gt; boolean isSequenceTargeted(T targetItem) {
<span class="fc" id="L697">      TargetType objectType = TargetType.forClass(targetItem.getClass());</span>
<span class="fc bfc" id="L698" title="All 4 branches covered.">      return (Position.BEFORE.equals(position) || Position.AFTER.equals(position))</span>
<span class="pc bpc" id="L699" title="1 of 4 branches missed.">          &amp;&amp; (TargetType.PARAM.equals(objectType) &amp;&amp; isMatchingType(TargetType.PARAM)</span>
<span class="pc bpc" id="L700" title="2 of 4 branches missed.">              || TargetType.PART.equals(objectType) &amp;&amp; isMatchingType(TargetType.PART));</span>
    }

    /**
     * Determine if the provided {@code obj} is the target of the add.
     *
     * @param obj
     *          the current object
     * @return {@code true} if the current object applies or {@code false} otherwise
     */
    private boolean appliesTo(@NonNull Object obj) {
<span class="fc" id="L711">      TargetType objectType = TargetType.forClass(obj.getClass());</span>

<span class="pc bpc" id="L713" title="1 of 4 branches missed.">      boolean retval = objectType != null &amp;&amp; isMatchingType(objectType);</span>
<span class="fc bfc" id="L714" title="All 2 branches covered.">      if (retval) {</span>
<span class="pc bpc" id="L715" title="1 of 2 branches missed.">        assert objectType != null;</span>

        // check other criteria
<span class="fc" id="L718">        String actualId = null;</span>
<span class="pc bpc" id="L719" title="1 of 4 branches missed.">        switch (objectType) {</span>
        case CONTROL: {
<span class="fc" id="L721">          Control control = (Control) obj;</span>
<span class="fc" id="L722">          actualId = control.getId();</span>
<span class="fc" id="L723">          break;</span>
        }
        case PARAM: {
<span class="fc" id="L726">          Parameter param = (Parameter) obj;</span>
<span class="fc" id="L727">          actualId = param.getId();</span>
<span class="fc" id="L728">          break;</span>
        }
        case PART: {
<span class="fc" id="L731">          ControlPart part = (ControlPart) obj;</span>
<span class="fc" id="L732">          String partId = part.getId();</span>
<span class="pc bpc" id="L733" title="1 of 2 branches missed.">          if (part.getId() != null) {</span>
<span class="fc" id="L734">            actualId = partId;</span>
          }
          break;
        }
        default:
<span class="nc" id="L739">          throw new UnsupportedOperationException(objectType.fieldName());</span>
        }

<span class="fc" id="L742">        String byId = getById();</span>
<span class="pc bpc" id="L743" title="3 of 4 branches missed.">        if (getById() == null &amp;&amp; TargetType.CONTROL.equals(objectType)) {</span>
<span class="nc" id="L744">          retval = getControl().equals(obj);</span>
        } else {
<span class="pc bpc" id="L746" title="1 of 4 branches missed.">          retval = byId != null &amp;&amp; byId.equals(actualId);</span>
        }
      }
<span class="fc" id="L749">      return retval;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>